{% extends 'base.html' %}
{% load static %}

{% block title %}Create Post - {{ club.name }} - ClubiFy{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'vendor/easymde/easymde.min.css' %}">
<style>
.EasyMDEContainer .CodeMirror { border: 1px solid #e5e7eb; border-radius: 0.5rem; }
.EasyMDEContainer .CodeMirror-focused { border-color: var(--color-primary-500, #0046FF); }

/* EasyMDE Preview Styling */
.EasyMDEContainer .editor-preview,
.EasyMDEContainer .editor-preview-side {
  padding: 1rem;
  background: #fafafa;
  color: #374151;
  font-size: 0.95rem;
  line-height: 1.7;
}
.EasyMDEContainer .editor-preview h1,
.EasyMDEContainer .editor-preview-side h1 { font-size: 2em; font-weight: 700; margin: 1em 0 0.5em; color: #111827; }
.EasyMDEContainer .editor-preview h2,
.EasyMDEContainer .editor-preview-side h2 { font-size: 1.5em; font-weight: 700; margin: 1em 0 0.5em; color: #111827; }
.EasyMDEContainer .editor-preview h3,
.EasyMDEContainer .editor-preview-side h3 { font-size: 1.25em; font-weight: 700; margin: 1em 0 0.5em; color: #111827; }
.EasyMDEContainer .editor-preview p,
.EasyMDEContainer .editor-preview-side p { margin: 1em 0; }
.EasyMDEContainer .editor-preview ul,
.EasyMDEContainer .editor-preview-side ul { list-style: disc; padding-left: 1.5em; margin: 1em 0; }
.EasyMDEContainer .editor-preview ol,
.EasyMDEContainer .editor-preview-side ol { list-style: decimal; padding-left: 1.5em; margin: 1em 0; }
.EasyMDEContainer .editor-preview li,
.EasyMDEContainer .editor-preview-side li { margin: 0.25em 0; }
.EasyMDEContainer .editor-preview strong,
.EasyMDEContainer .editor-preview-side strong { font-weight: 700; color: #111827; }
.EasyMDEContainer .editor-preview em,
.EasyMDEContainer .editor-preview-side em { font-style: italic; }
.EasyMDEContainer .editor-preview code,
.EasyMDEContainer .editor-preview-side code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875em; font-family: ui-monospace, monospace; }
.EasyMDEContainer .editor-preview pre,
.EasyMDEContainer .editor-preview-side pre { background: #1f2937; color: #f9fafb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1em 0; }
.EasyMDEContainer .editor-preview pre code,
.EasyMDEContainer .editor-preview-side pre code { background: transparent; padding: 0; color: inherit; }
.EasyMDEContainer .editor-preview blockquote,
.EasyMDEContainer .editor-preview-side blockquote { border-left: 4px solid #6685ff; padding-left: 1rem; margin: 1em 0; color: #6b7280; font-style: italic; }
.EasyMDEContainer .editor-preview a,
.EasyMDEContainer .editor-preview-side a { color: #0039cc; text-decoration: underline; }
.EasyMDEContainer .editor-preview hr,
.EasyMDEContainer .editor-preview-side hr { border: none; border-top: 1px solid #e5e7eb; margin: 2em 0; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="mb-8">
        <a href="{% url 'clubs:club_detail' slug=club.slug %}" class="inline-flex items-center gap-2 text-primary-700 hover:text-primary-800 font-medium text-sm bg-white px-3 py-1.5 rounded-md border border-gray-200 shadow-sm hover:border-primary-300 transition">
            <i class="fas fa-arrow-left"></i>
            <span>Back to {{ club.name }}</span>
        </a>
        <h1 class="text-3xl font-bold text-gray-900 mt-4 flex items-center gap-3">
            {% if can_create_news %}
                <span>Create a Post</span>
            {% else %}
                <i class="fas fa-blog text-primary-600"></i>
                <span>Create a Blog Post</span>
            {% endif %}
        </h1>
        <p class="text-gray-600 mt-1">
            {% if can_create_news %}
                As a {{ membership.get_role_display }}, you can create both Blog and News posts.
            {% else %}
                Share your thoughts with the club community.
            {% endif %}
        </p>
    </div>

    <div class="card p-8">
        <form method="post" class="space-y-6">
            {% csrf_token %}
            
            {% if can_create_news %}
            <div>
                <label for="id_post_type" class="label">Post Type</label>
                {{ form.post_type }}
                {% if form.post_type.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.post_type.errors.0 }}</p>
                {% endif %}
            </div>
            {% endif %}

            <div>
                <label for="id_title" class="label">Title</label>
                {{ form.title }}
                {% if form.title.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.title.errors.0 }}</p>
                {% endif %}
            </div>

            <div>
                <label for="id_body" class="label">Content</label>
                {{ form.body }}
                {% if form.body.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.body.errors.0 }}</p>
                {% endif %}
            </div>

            {% if form.non_field_errors %}
                <div class="bg-red-100 text-red-800 rounded-lg p-3">
                    {% for error in form.non_field_errors %}
                        <p class="text-sm">{{ error }}</p>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="flex items-center justify-between pt-4">
                <a href="{% url 'clubs:club_detail' slug=club.slug %}" class="text-gray-600 hover:text-gray-900">
                    Cancel
                </a>
                <button type="submit" class="btn btn-primary">
                    Publish Post
                </button>
            </div>
        </form>
    </div>
    
    <div class="mt-6 p-3 sm:p-4 bg-slate-50 border border-blue-100 rounded-lg">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-info-circle text-blue-600 text-sm sm:text-base"></i>
            </div>
            <div class="flex-1">
                <p class="text-xs sm:text-sm text-gray-700">
                    <span class="font-semibold">Markdown editor:</span> Use the toolbar for formatting, or type Markdown.
                </p>    
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/easymde/easymde.min.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var el = document.getElementById('id_body');
  if (!el) return;
  var mde;
  try {
    mde = new EasyMDE({
      element: el,
      placeholder: 'Write your post here... Use the toolbar or type **bold**, *italic*, # headers, * lists, `code`.',
      status: false,
      spellChecker: false,
      autoDownloadFontAwesome: false,
      minHeight: '280px',
      autosave: { enabled: false },
      forceSync: true,
      unorderedListStyle: '*',
      toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'code', 'undo', 'redo', 'link', 'preview','|', 'guide']
    });
  } catch (e) {
    return;
  }
  var form = el.closest('form');
  if (form) {
    function syncBody() {
      try {
        if (mde && typeof mde.value === 'function') {
          var bodyEl = form.elements['body'] || el;
          if (bodyEl) bodyEl.value = mde.value();
        }
      } catch (err) {}
    }
    form.addEventListener('submit', syncBody);
    var btn = form.querySelector('button[type="submit"]');
    if (btn) btn.addEventListener('click', syncBody, true);
  }
});
</script>
{% endblock %}
